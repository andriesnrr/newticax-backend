name: Run Backend API Tests

on:
  push:
  pull_request:

jobs:
  api-tests:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:5.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.adminCommand(\"ping\")'" 
          --health-interval=10s 
          --health-timeout=5s 
          --health-retries=5

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v3

      - name: 🟢 Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: 📦 Install dependencies
        run: npm ci

      - name: ⚙️ Create .env file
        run: |
          echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env
          echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> .env
          echo "ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}" >> .env
          echo "AUTH_RATE_LIMIT_MAX=5" >> .env
          echo "CACHE_TTL=3600" >> .env
          echo "COOKIE_SECRET=${{ secrets.COOKIE_SECRET }}" >> .env
          echo "CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}" >> .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "FROM_EMAIL=${{ secrets.FROM_EMAIL }}" >> .env
          echo "FROM_NAME=NewticaX" >> .env
          echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> .env
          echo "GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }}" >> .env
          echo "GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "LOG_FILE=logs/app.log" >> .env
          echo "LOG_LEVEL=info" >> .env
          echo "MAX_FILE_SIZE=5242880" >> .env
          echo "NEWS_API_BASE_URL=https://newsapi.org/v2" >> .env
          echo "NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}" >> .env
          echo "NEWS_CACHE_TTL=1800" >> .env
          echo "NODE_ENV=production" >> .env
          echo "NODE_OPTIONS=--max-old-space-size=4096" >> .env
          echo "OAUTH_CALLBACK_URL=${{ secrets.OAUTH_CALLBACK_URL }}" >> .env
          echo "PORT=4000" >> .env
          echo "RATE_LIMIT_MAX=100" >> .env
          echo "RATE_LIMIT_WINDOW=900000" >> .env
          echo "REDIS_URL=${{ secrets.REDIS_URL }}" >> .env
          echo "SMTP_HOST=smtp.gmail.com" >> .env
          echo "SMTP_PASS=${{ secrets.SMTP_PASS }}" >> .env
          echo "SMTP_PORT=587" >> .env
          echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env
          echo "UPLOAD_DIR=uploads" >> .env


      - name: 🚀 Start backend server
        run: |
          npm run build
          nohup npm run start & sleep 5

      - name: 🧪 Run API Tests
        run: npm test
